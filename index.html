<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>לוח גאנט — יפיפה וצבעוני</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css" rel="stylesheet">
<style>
  :root{
    --pedagogi:#ef4b6c;
    --kehila:#1fb6d5;
    --tech:#ff9800;
    --mosdi:#43a047;
    --hevra:#9e9e9e;
    --bg:#f6f7fb;
  }
  body{background:var(--bg);}
  .hero {
    background: radial-gradient(1200px 500px at 80% -30%, rgba(99,102,241,.12), transparent 60%),
                radial-gradient(1200px 500px at 0% 120%, rgba(99,102,241,.08), transparent 60%);
  }
  .card{border:0; border-radius:20px; box-shadow:0 10px 24px rgba(24,39,75,.05), 0 2px 6px rgba(24,39,75,.03);}
  .chip{border-radius:999px; padding:.4rem .9rem; font-weight:600; cursor:pointer; user-select:none; border:1px solid rgba(0,0,0,.05);}
  .chip.active{outline:3px solid rgba(0,0,0,.07); background:#fff;}
  .chip-p{background:rgba(239,75,108,.12); color:#b32646;}
  .chip-k{background:rgba(31,182,213,.12); color:#0e6883;}
  .chip-t{background:rgba(255,152,0,.14); color:#8a5b00;}
  .chip-m{background:rgba(67,160,71,.14); color:#2a6d32;}
  .chip-h{background:rgba(158,158,158,.16); color:#4d4d4d;}
  .chip-all{background:#fff;}
  /* Gantt bar colors */
  .gantt .bar-פדגוגי{ fill: var(--pedagogi); }
  .gantt .bar-קהילתי{ fill: var(--kehila); }
  .gantt .bar-טכנולוגי{ fill: var(--tech); }
  .gantt .bar-מוסדי{ fill: var(--mosdi); }
  .gantt .bar-חברתי{ fill: var(--hevra); }
  /* Today marker */
  .gantt .today-highlight line{ stroke: #6c63ff; stroke-width: 2; stroke-dasharray: 4 4; }
  /* Popup */
  .details-container{ background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:8px 12px; }
  .legend span{display:inline-flex; align-items:center; gap:.5rem; margin-inline-end:1rem;}
  .legend i{display:inline-block; width:14px; height:14px; border-radius:3px;}
  .lg-p{background:var(--pedagogi);} .lg-k{background:var(--kehila);} .lg-t{background:var(--tech);}
  .lg-m{background:var(--mosdi);} .lg-h{background:var(--hevra);}
</style>
</head>
<body>
  <header class="hero py-4 mb-2">
    <div class="container d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h1 class="h3 mb-1">לוח גאנט – בית הספר</h1>
        <div class="legend text-muted small">
          <span><i class="lg-p"></i> פדגוגי</span>
          <span><i class="lg-k"></i> קהילתי</span>
          <span><i class="lg-t"></i> טכנולוגי</span>
          <span><i class="lg-m"></i> מוסדי</span>
          <span><i class="lg-h"></i> חברתי</span>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="btn-import" class="btn btn-outline-primary btn-sm">ייבוא JSON</button>
        <button id="btn-export" class="btn btn-outline-secondary btn-sm">יצוא CSV</button>
      </div>
    </div>
  </header>

  <main class="container pb-5">
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-center gap-2">
        <span class="fw-bold me-2">סינון לפי תחום:</span>
        <span class="chip chip-all active" data-domain="ALL">הכל</span>
        <span class="chip chip-p" data-domain="פדגוגי">פדגוגי</span>
        <span class="chip chip-k" data-domain="קהילתי">קהילתי</span>
        <span class="chip chip-t" data-domain="טכנולוגי">טכנולוגי</span>
        <span class="chip chip-m" data-domain="מוסדי">מוסדי</span>
        <span class="chip chip-h" data-domain="חברתי">חברתי</span>
        <div class="ms-auto d-flex gap-2">
          <select id="viewMode" class="form-select form-select-sm" style="width:auto;">
            <option value="Month" selected>חודש</option>
            <option value="Quarter Day">רבע יום</option>
            <option value="Day">יום</option>
            <option value="Week">שבוע</option>
            <option value="Year">שנה</option>
          </select>
          <button id="btn-today" class="btn btn-sm btn-outline-dark">היום</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body" style="overflow-x:auto;">
        <div id="gantt" style="min-width:1100px;"></div>
      </div>
    </div>
  </main>

  <input type="file" id="file-input" accept="application/json" hidden>

  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <script>
    const DEFAULTS = [
      { id:"1", domain:"פדגוגי", name:"סדנת פתיחת שנה והצגת חזון", start:"2025-09-05", end:"2025-09-10", progress:100 },
      { id:"2", domain:"קהילתי", name:"מיפוי תלמידי שכבה והערכת פערים", start:"2025-09-15", end:"2025-10-10", progress:60 },
      { id:"3", domain:"טכנולוגי", name:"יישומי PBL ראשוניים", start:"2025-10-15", end:"2025-11-20", progress:20 },
      { id:"4", domain:"מוסדי", name:"השקת תחנת רדיו בית ספרית", start:"2025-11-01", end:"2025-11-30", progress:0 },
      { id:"5", domain:"חברתי", name:"סדנאות SEL חווייתיות", start:"2025-12-01", end:"2025-12-10", progress:30 }
    ];

    let TASKS = DEFAULTS.slice();
    let gantt, currentView = 'Month', currentDomain = 'ALL';

    function filteredTasks(){
      return currentDomain === 'ALL' ? TASKS : TASKS.filter(t=>t.domain === currentDomain);
    }
    function toGantt(list){
      return list.map(t => ({
        id: t.id, name: t.name, start: t.start, end: t.end, progress: t.progress||0,
        custom_class: 'bar-' + t.domain
      }));
    }
    function render(){
      const el = document.getElementById('gantt');
      el.innerHTML = "";
      gantt = new Gantt("#gantt", toGantt(filteredTasks()), {
        view_mode: currentView,
        custom_popup_html: task => {
          const t = TASKS.find(x=>x.id===task.id) || task;
          return `<div class="details-container">
            <div class="fw-bold">${task.name}</div>
            <div>תחום: ${t.domain}</div>
            <div>תאריכים: ${task.start} → ${task.end}</div>
            <div>התקדמות: ${task.progress}%</div>
          </div>`;
        }
      });
      markToday();
    }
    function markToday(){
      const svg = document.querySelector('#gantt svg');
      if(!svg) return;
      const today = new Date(); today.setHours(0,0,0,0);
      // Find x coordinate for today by scanning date ticks
      const ticks = svg.querySelectorAll('.lower-text'); // bottom axis labels
      let x = null;
      ticks.forEach(t=>{
        const title = t.textContent;
        // heuristic: find first tick with today's day number when in Day/Week/Month views
        const n = today.getDate();
        if (String(n) === title.replace(/[^0-9]/g,'')) {
          const g = t.closest('g');
          if (g){ const tr = g.getAttribute('transform'); const m = /translate\(([-0-9\.]+),([-0-9\.]+)\)/.exec(tr||''); if(m) x = parseFloat(m[1]); }
        }
      });
      if (x!==null){
        const h = svg.getBBox().height;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x); line.setAttribute('x2', x);
        line.setAttribute('y1', 0); line.setAttribute('y2', h);
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class','today-highlight');
        g.appendChild(line);
        svg.appendChild(g);
      }
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      render();

      // Filter chips
      document.querySelectorAll('.chip').forEach(c=>{
        c.addEventListener('click', ()=>{
          document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
          c.classList.add('active');
          currentDomain = c.dataset.domain;
          render();
        });
      });

      // View mode
      document.getElementById('viewMode').addEventListener('change', (e)=>{
        currentView = e.target.value; render();
      });

      // Today jump (re-render keeps centered)
      document.getElementById('btn-today').addEventListener('click', ()=> render());

      // Import/Export
      document.getElementById('btn-import').onclick = ()=> document.getElementById('file-input').click();
      document.getElementById('file-input').onchange = async (e)=>{
        const f = e.target.files[0]; if(!f) return;
        try{
          const text = await f.text(); const json = JSON.parse(text);
          if(!Array.isArray(json)) throw new Error('JSON חייב להיות מערך משימות');
          TASKS = json; render(); alert('ייבוא הושלם');
        }catch(err){ alert('שגיאה בייבוא: ' + err.message); }
        finally { e.target.value = ""; }
      };
      document.getElementById('btn-export').onclick = ()=>{
        const headers = ["id","domain","name","start","end","progress"];
        const rows = TASKS.map(t=>headers.map(h=>t[h]??""));
        const csv = [headers, ...rows].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gantt.csv'; a.click();
      };
    });
  </script>
</body>
</html>
