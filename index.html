import pandas as pd
import json
from pathlib import Path

# Load the Excel uploaded by the user
file_path = "/mnt/data/gantt-fixed.xlsx"
df = pd.read_excel(file_path)


# Ensure datetime types
df["start"] = pd.to_datetime(df["start"])
df["end"] = pd.to_datetime(df["end"])

# Normalize domains and collect unique
df["domain"] = df["domain"].astype(str).str.strip()
domains = sorted(df["domain"].dropna().unique().tolist())

# Color palette for known domains (fallbacks if new ones appear)
default_colors = {
    "פדגוגי": "#ef4444",
    "מוסדי": "#a855f7",
    "חברתי": "#f59e0b",
    "טכנולוגי": "#3b82f6",
    "קהילתי": "#22c55e"
}
# Assign colors in deterministic order
assigned_colors = {}
palette_cycle = ["#ef4444", "#22c55e", "#3b82f6", "#a855f7", "#f59e0b", "#14b8a6", "#e11d48", "#0ea5e9"]
i = 0
for d in domains:
    assigned_colors[d] = default_colors.get(d, palette_cycle[i % len(palette_cycle)])
    i += 1

# Build items array from the dataframe
items = []
for _, row in df.iterrows():
    items.append({
        "id": int(row["id"]),
        "group": str(row["domain"]),
        "content": str(row["name"]),
        "start": row["start"].strftime("%Y-%m-%d"),
        "end": row["end"].strftime("%Y-%m-%d"),
        "title": f"סטטוס: {int(row['progress'])}%"
    })

# Create the HTML content
html_template = f"""<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>לוח גאנט — עברית (ייבוא מ-Excel)</title>

  <!-- vis-timeline CDN -->
  <link rel="stylesheet" href="https://unpkg.com/vis-timeline@7.7.0/styles/vis-timeline-graph2d.min.css">
  <script src="https://unpkg.com/vis-data@7.1.4/peer/umd/vis-data.min.js"></script>
  <script src="https://unpkg.com/vis-timeline@7.7.0/peer/umd/vis-timeline-graph2d.min.js"></script>

  <style>
    :root{{
      --bg:#f7f7f9;
      --card:#ffffff;
      --ink:#111;
      --muted:#6b7280;
      --accent:#0ea5e9;
      --radius:16px;
      --shadow:0 8px 24px rgba(0,0,0,.08);
    }}
    *{{box-sizing:border-box}}
    body{{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: "Heebo", "Rubik", "Assistant", "Arial", sans-serif;
      line-height:1.45;
      direction: rtl;
      text-align:right;
    }}
    header{{ padding:22px 18px 6px; }}
    h1{{ margin:0 0 8px; font-size: clamp(22px, 3vw, 34px); font-weight:800; }}
    .toolbar{{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:14px;
    }}
    .toolbar .btn{{
      background:var(--card); border:1px solid #e5e7eb; padding:8px 12px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow);
    }}
    .panel{{ margin:10px 18px 24px; background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius); box-shadow: var(--shadow);}}
    #timeline{{ height:380px; border-radius: var(--radius);}}
    .legend{{ display:flex; gap:10px; padding:10px 14px 14px; flex-wrap:wrap; border-top:1px dashed #e5e7eb; font-size:14px; color:#374151; }}
    .dot{{ display:inline-block; inline-size:12px; block-size:12px; border-radius:99px; margin-inline-end:6px; vertical-align:middle; }}

    .table-wrap{{ margin:0 18px 60px; background:var(--card); border:1px solid #e5e7eb; border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }}
    .table-head{{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eef2f7; }}
    .table-head h2{{ margin:0; font-size:18px; font-weight:800; }}
    .filter-row{{ padding:10px 16px; border-bottom:1px dashed #eef2f7; display:flex; gap:16px; flex-wrap:wrap; align-items:center; color:#374151; font-size:14px; }}
    table{{ width:100%; border-collapse:separate; border-spacing:0; font-size:14px; }}
    thead th{{ position:sticky; top:0; background:#fafafa; z-index:1; text-align:right; padding:10px 12px; border-bottom:1px solid #e5e7eb; font-weight:700; color:#111827; white-space:nowrap; }}
    tbody td{{ padding:10px 12px; border-bottom:1px solid #f1f5f9; vertical-align:top; }}
    tbody tr:hover{{background:#fbfdff}}
    .chip{{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#f3f4f6; color:#111827; font-weight:600; font-size:12px; line-height:1; }}
    .status{{ font-weight:700; padding:4px 8px; border-radius:8px; display:inline-block; }}
    .s-done{{background:#e8faf1;color:#0f766e}} .s-plan{{background:#eef2ff;color:#4338ca}} .s-progress{{background:#fff7ed;color:#b45309}}

    .vis-timeline{{ border:none !important; border-radius:var(--radius);}}
    .vis-item .vis-item-content{{ padding:6px 10px; font-weight:700;}}
  </style>
</head>
<body>
  <header>
    <h1>לוח גאנט — בית הספר (ייבוא מ-Excel)</h1>
    <div class="toolbar">
      <button class="btn" id="zoomIn">התקרב</button>
      <button class="btn" id="zoomOut">התרחק</button>
      <button class="btn" id="fitAll">התאם לכל הטווח</button>
      <span class="small" style="color:#6b7280">RTL · חודשים בעברית</span>
    </div>
  </header>

  <section class="panel">
    <div id="timeline"></div>
    <div class="legend" id="legend"></div>
  </section>

  <section class="table-wrap">
    <div class="table-head">
      <h2>טבלת משימות</h2>
      <div class="small" style="color:#6b7280">המשימות נטענו מקובץ ה-Excel שלך</div>
    </div>

    <div class="filter-row" id="filters"></div>

    <div style="max-height:520px; overflow:auto;">
      <table id="tasksTable">
        <thead>
          <tr>
            <th>#</th>
            <th>תחום</th>
            <th>פעולה</th>
            <th>התחלה</th>
            <th>סיום</th>
            <th>סטטוס</th>
            <th>פעולות</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
    // ====== נתונים שיוצרו מה-Excel ======
    const DOMAIN_COLORS = {json.dumps(assigned_colors, ensure_ascii=False)};
    const itemsArray = {json.dumps(items, ensure_ascii=False)};

    // ====== vis DataSets ======
    const groupsData = new vis.DataSet(Object.keys(DOMAIN_COLORS).map((name) => ({{ id: name, content: name }})));
    const itemsData = new vis.DataSet(itemsArray);

    // ====== Legend and filters ======
    const legend = document.getElementById('legend');
    const filters = document.getElementById('filters');

    Object.entries(DOMAIN_COLORS).forEach(([name, color])=>{{
      const span = document.createElement('span');
      span.innerHTML = `<span class="dot" style="background:${{color}}"></span>${{name}}`;
      legend.appendChild(span);

      const label = document.createElement('label');
      label.style.marginInlineEnd = '12px';
      label.innerHTML = `<input type="checkbox" class="domain-filter" value="${{name}}" checked> ${{name}}`;
      filters.appendChild(label);
    }});

    // ====== Timeline ======
    const container = document.getElementById('timeline');

    function itemTemplate(item, element){{
      const color = DOMAIN_COLORS[item.group] || '#999';
      element.style.background = color;
      element.style.borderColor = color;
      element.style.color = '#fff';
      element.title = item.title || item.content;
      return element;
    }}

    // Calculate default window from min/max of items
    const dates = itemsArray.flatMap(it => [new Date(it.start), new Date(it.end)]);
    const minDate = new Date(Math.min(...dates.map(d=>d.getTime())));
    const maxDate = new Date(Math.max(...dates.map(d=>d.getTime())));

    const options = {{
      locale: 'he',
      orientation: 'top',
      rtl: true,
      stack: true,
      maxHeight: 380,
      zoomMin: 1000 * 60 * 60 * 24 * 3,
      zoomMax: 1000 * 60 * 60 * 24 * 366 * 3,
      start: minDate,
      end: maxDate,
      editable: false,
      margin: {{item:{{horizontal:6, vertical:8}}}},
      template: itemTemplate,
      groupOrder: (a,b)=> a.id.localeCompare(b.id, 'he')
    }};

    const timeline = new vis.Timeline(container, itemsData, groupsData, options);

    // Zoom controls
    const ZOOM_STEP = 0.6;
    function setRange(start, end){{ timeline.setWindow(start, end, {{animation: {{duration:400}}}}); }}
    function getRange(){{ const r = timeline.getWindow(); return {{start:r.start.valueOf(), end:r.end.valueOf()}}; }}
    document.getElementById('zoomIn').onclick = ()=>{{ const r=getRange(); const i=r.end-r.start; const ni=i*ZOOM_STEP; const c=r.start+i/2; setRange(c-ni/2, c+ni/2); }};
    document.getElementById('zoomOut').onclick = ()=>{{ const r=getRange(); const i=r.end-r.start; const ni=i/ZOOM_STEP; const c=r.start+i/2; setRange(c-ni/2, c+ni/2); }};
    document.getElementById('fitAll').onclick = ()=> setRange(minDate, maxDate);

    // ====== Table rendering ======
    const tableBody = document.querySelector('#tasksTable tbody');
    const statusClass = s => (s>=100? 's-done' : s>0 ? 's-progress': 's-plan');

    function fmtDate(d){{ return new Date(d).toLocaleDateString('he-IL', {{year:'numeric', month:'2-digit', day:'2-digit'}}); }}

    function renderTable(selected){{
      tableBody.innerHTML = '';
      const visible = itemsArray.filter(it => !selected || selected.has(it.group))
                                .sort((a,b)=> new Date(a.start)-new Date(b.start));
      visible.forEach((it, idx)=>{{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${{idx+1}}</td>
          <td><span class="chip"><span class="dot" style="background:${{DOMAIN_COLORS[it.group]||'#999'}}"></span>${{it.group}}</span></td>
          <td><strong>${{it.content}}</strong></td>
          <td>${{fmtDate(it.start)}}</td>
          <td>${{fmtDate(it.end)}}</td>
          <td><span class="status ${{statusClass(parseInt((it.title||'0').replace(/\\D/g,'')))}}">${{(it.title||'0')}}</span></td>
          <td><a href="#!" onclick="timeline.focus(${{JSON.stringify(it.id)}});return false;">הצג בגאנט</a></td>
        `;
        tableBody.appendChild(tr);
      }});
    }}
    renderTable();

    // Filters
    function rebuild(){{
      const selected = new Set([...document.querySelectorAll('.domain-filter')].filter(i=>i.checked).map(i=>i.value));
      // Update timeline items
      const filtered = itemsArray.filter(it => selected.has(it.group));
      timeline.setItems(new vis.DataSet(filtered));
      timeline.setGroups(groupsData);
      renderTable(selected);
    }}
    document.querySelectorAll('.domain-filter').forEach(el => el.addEventListener('change', rebuild));
  </script>
</body>
</html>
"""

# Save to file
out_path = Path("/mnt/data/index.html")
out_path.write_text(html_template, encoding="utf-8")

out_path.as_posix()
