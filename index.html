<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>×œ×•×— ×’×× ×˜ â€” ××œ× ×’'××— ×©×›×‘×” ×™' (×’×¨×¡×” ×›×”×”)</title>
  <!-- Bootstrap RTL -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Frappe Gantt -->
  <link href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css" rel="stylesheet">
  <!-- SheetJS for XLSX/CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#11121a;
      --panel:#1b1d2b;
      --panel-2:#232535;
      --text:#e8e8f0;
      --muted:#b9bfd6;
      --brand:#7c6cff;
      --chip:#2b2e44;
      --chip-active:#7c6cff;
      --pedagogi:#ef4b6c;
      --kehila:#1fb6d5;
      --tech:#ff9800;
      --mosdi:#43a047;
      --hevra:#9e9e9e;
    }
    html,body{background:var(--bg); color:var(--text);}
    .hero-dark{
      background: linear-gradient(120deg,#191b28 0%, #23263a 60%, #2b2e44 100%);
      border-bottom:1px solid rgba(255,255,255,.05);
      box-shadow:0 6px 24px rgba(0,0,0,.35);
    }
    .card{background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:20px;}
    .legend span{display:inline-flex; align-items:center; gap:.5rem; margin-inline-end:1rem; color:var(--muted);}
    .legend i{display:inline-block; width:14px; height:14px; border-radius:3px;}
    .lg-p{background:var(--pedagogi);} .lg-k{background:var(--kehila);} .lg-t{background:var(--tech);}
    .lg-m{background:var(--mosdi);} .lg-h{background:var(--hevra);}

    .chip{border-radius:999px; padding:.45rem 1rem; font-weight:600; cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.06); background:var(--chip); color:var(--text);}
    .chip:hover{filter:brightness(1.1);}
    .chip.active{background:var(--chip-active); border-color:transparent; color:#fff;}
    .chip-all{background:transparent; border:1px dashed rgba(255,255,255,.15);}
    .form-select, .btn{border-radius:999px;}
    .btn-outline-light{border-color:rgba(255,255,255,.35); color:#fff;}
    .btn-outline-light:hover{background:#fff; color:#111;}
    .btn-outline-secondary{color:#ddd; border-color:#565973;}
    .btn-outline-secondary:hover{background:#ddd; color:#111;}

    /* Gantt colors */
    .gantt .bar-×¤×“×’×•×’×™{ fill: var(--pedagogi); }
    .gantt .bar-×§×”×™×œ×ª×™{ fill: var(--kehila); }
    .gantt .bar-×˜×›× ×•×œ×•×’×™{ fill: var(--tech); }
    .gantt .bar-××•×¡×“×™{ fill: var(--mosdi); }
    .gantt .bar-×—×‘×¨×ª×™{ fill: var(--hevra); }
    .gantt .bar-progress{ fill: rgba(0,0,0,.25); }

    /* Today marker */
    .gantt .today-highlight line{ stroke: var(--brand); stroke-width: 2; stroke-dasharray: 4 4; }

    /* Popup */
    .details-container{
      background: var(--panel-2);
      color: var(--text);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:10px 12px;
      box-shadow:0 8px 24px rgba(0,0,0,.4);
    }

    a, a:visited{color:#b8b2ff;}
  </style>
</head>
<body>
  <header class="hero-dark py-4 mb-3">
    <div class="container d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h1 class="h3 mb-1 text-light">ğŸ“˜ ××œ× ×’'××— â€“ Ø±Ù‡Ø·</h1>
        <div class="legend small">
          <span><i class="lg-p"></i> ×¤×“×’×•×’×™</span>
          <span><i class="lg-k"></i> ×§×”×™×œ×ª×™</span>
          <span><i class="lg-t"></i> ×˜×›× ×•×œ×•×’×™</span>
          <span><i class="lg-m"></i> ××•×¡×“×™</span>
          <span><i class="lg-h"></i> ×—×‘×¨×ª×™</span>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="btn-import" class="btn btn-outline-light btn-sm">×™×™×‘×•× ×§×•×‘×¥</button>
        <button id="btn-export" class="btn btn-outline-light btn-sm">×™×¦×•× CSV</button>
      </div>
    </div>
  </header>

  <main class="container pb-5">
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-center gap-2">
        <span class="fw-bold me-2" style="color:var(--muted)">×¡×™× ×•×Ÿ ×œ×¤×™ ×ª×—×•×:</span>
        <span class="chip chip-all active" data-domain="ALL">×”×›×œ</span>
        <span class="chip" data-domain="×¤×“×’×•×’×™">×¤×“×’×•×’×™</span>
        <span class="chip" data-domain="×§×”×™×œ×ª×™">×§×”×™×œ×ª×™</span>
        <span class="chip" data-domain="×˜×›× ×•×œ×•×’×™">×˜×›× ×•×œ×•×’×™</span>
        <span class="chip" data-domain="××•×¡×“×™">××•×¡×“×™</span>
        <span class="chip" data-domain="×—×‘×¨×ª×™">×—×‘×¨×ª×™</span>
        <div class="ms-auto d-flex gap-2">
          <select id="viewMode" class="form-select form-select-sm" style="width:auto; background:var(--panel-2); color:var(--text); border:1px solid rgba(255,255,255,.12);">
            <option value="Month" selected>×—×•×“×©</option>
            <option value="Week">×©×‘×•×¢</option>
            <option value="Day">×™×•×</option>
            <option value="Quarter Day">×¨×‘×¢ ×™×•×</option>
            <option value="Year">×©× ×”</option>
          </select>
          <button id="btn-today" class="btn btn-sm btn-outline-secondary">×”×™×•×</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body" style="overflow-x:auto;">
        <div id="gantt" style="min-width:1100px;"></div>
      </div>
    </div>
  </main>

  <input type="file" id="file-input" accept=".json,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" hidden>

  <!-- Frappe Gantt -->
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <script>
    // ===== × ×ª×•× ×™ ×‘×¨×™×¨×ª ××—×“×œ =====
    const DEFAULTS = [
      { id:"1", domain:"×¤×“×’×•×’×™", name:"×¡×“× ×ª ×¤×ª×™×—×ª ×©× ×” ×•×”×¦×’×ª ×—×–×•×Ÿ", start:"2025-09-05", end:"2025-09-10", progress:100 },
      { id:"2", domain:"×§×”×™×œ×ª×™", name:"××™×¤×•×™ ×ª×œ××™×“×™ ×©×›×‘×” ×•×”×¢×¨×›×ª ×¤×¢×¨×™×", start:"2025-09-15", end:"2025-10-10", progress:60 },
      { id:"3", domain:"×˜×›× ×•×œ×•×’×™", name:"×™×™×©×•××™ PBL ×¨××©×•× ×™×™×", start:"2025-10-15", end:"2025-11-20", progress:20 },
      { id:"4", domain:"××•×¡×“×™", name:"×”×©×§×ª ×ª×—× ×ª ×¨×“×™×• ×‘×™×ª ×¡×¤×¨×™×ª", start:"2025-11-01", end:"2025-11-30", progress:0 },
      { id:"5", domain:"×—×‘×¨×ª×™", name:"×¡×“× ××•×ª SEL ×—×•×•×™×™×ª×™×•×ª", start:"2025-12-01", end:"2025-12-10", progress:30 }
    ];

    let TASKS = DEFAULTS.slice();
    let gantt, currentView = 'Month', currentDomain = 'ALL';

    // ===== ×¢×–×¨×™ × ×ª×•× ×™× =====
    function normalizeTask(t){
      // ×ª××™×›×” ×‘×›×•×ª×¨×•×ª ×‘×¢×‘×¨×™×ª/×× ×’×œ×™×ª ××”×§×•×‘×¥
      const map = {
        id: t.id ?? t.ID ?? t.Id ?? t['××¡×¤×¨'],
        domain: t.domain ?? t['×ª×—×•×'] ?? t.Domain,
        name: t.name ?? t['×¤×¢×•×œ×”'] ?? t.Task ?? t.Title ?? t.Name ?? t['××©×™××”'],
        start: t.start ?? t['×”×ª×—×œ×”'] ?? t.Start,
        end: t.end ?? t['×¡×™×•×'] ?? t.End,
        progress: Number(t.progress ?? t['×”×ª×§×“××•×ª'] ?? t.Progress ?? 0)
      };
      // ×¤×•×¨××˜ ×ª××¨×™×š ×œ×’×× ×˜ (YYYY-MM-DD)
      const toISO = (v)=>{
        if(!v) return v;
        const s = String(v).trim();
        if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; // YYYY-MM-DD
        const m1 = s.match(/^(\d{1,2})[\/\.\-](\d{1,2})[\/\.\-](\d{2,4})$/); // DD/MM/YYYY
        if(m1){
          const d = m1[1].padStart(2,'0'), mo = m1[2].padStart(2,'0');
          const y = m1[3].length===2 ? '20'+m1[3] : m1[3];
          return y+'-'+mo+'-'+d;
        }
        return s;
      };
      map.start = toISO(map.start);
      map.end = toISO(map.end);
      return map;
    }

    function filteredTasks(){
      return currentDomain === 'ALL' ? TASKS : TASKS.filter(t=>t.domain === currentDomain);
    }
    function toGantt(list){
      return list.map(t => ({
        id: t.id, name: t.name, start: t.start, end: t.end, progress: t.progress||0,
        custom_class: 'bar-' + t.domain
      }));
    }

    // ===== ×¨× ×“×¨ =====
    function render(){
      const el = document.getElementById('gantt');
      el.innerHTML = "";
      if(!filteredTasks().length){
        el.innerHTML = '<div class="text-center text-muted p-4">××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×”</div>';
        return;
      }
      gantt = new Gantt("#gantt", toGantt(filteredTasks()), {
        view_mode: currentView,
        custom_popup_html: task => {
          const t = TASKS.find(x=>x.id===task.id) || task;
          return `<div class="details-container">
            <div class="fw-bold">${task.name}</div>
            <div>×ª×—×•×: ${t.domain||'-'}</div>
            <div>×ª××¨×™×›×™×: ${task.start} â†’ ${task.end}</div>
            <div>×”×ª×§×“××•×ª: ${task.progress??0}%</div>
          </div>`;
        }
      });
      markToday();
    }

    function markToday(){
      const svg = document.querySelector('#gantt svg');
      if(!svg) return;
      const today = new Date(); today.setHours(0,0,0,0);
      const ticks = svg.querySelectorAll('.lower-text');
      let x = null;
      ticks.forEach(t=>{
        const txt = t.textContent || '';
        const n = today.getDate();
        if (String(n) === txt.replace(/[^0-9]/g,'')) {
          const g = t.closest('g'); if (!g) return;
          const tr = g.getAttribute('transform');
          const m = /translate\(([-0-9\.]+),([-0-9\.]+)\)/.exec(tr||'');
          if (m) x = parseFloat(m[1]);
        }
      });
      if (x!==null){
        const h = svg.getBBox().height;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', x); line.setAttribute('x2', x);
        line.setAttribute('y1', 0); line.setAttribute('y2', h);
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('class','today-highlight');
        g.appendChild(line);
        svg.appendChild(g);
      }
    }

    // ===== ×™×‘×•× / ×™×¦×•× =====
    async function handleFile(file){
      const name = (file.name||'').toLowerCase();
      const buf = await file.arrayBuffer();
      if (name.endsWith('.json')){
        const text = new TextDecoder().decode(buf);
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error('JSON ×—×™×™×‘ ×œ×”×™×•×ª ××¢×¨×š ××©×™××•×ª');
        TASKS = data.map(normalizeTask);
        render(); alert('×™×™×‘×•× JSON ×”×•×©×œ×');
        return;
      }
      // XLSX/CSV via SheetJS
      const wb = XLSX.read(buf, {type:'array'});
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet); // ××¢×¨×š ×©×œ ××•×‘×™×™×§×˜×™×
      if (!Array.isArray(rows) || !rows.length) throw new Error('×§×•×‘×¥ ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ');
      TASKS = rows.map(normalizeTask);
      render(); alert('×™×™×‘×•× ×§×•×‘×¥ ×”×•×©×œ×');
    }

    function exportCSV(){
      const headers = ["id","domain","name","start","end","progress"];
      const rows = TASKS.map(t=>headers.map(h=>t[h]??""));
      const csv = [headers, ...rows].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'gantt.csv';
      a.click();
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', ()=>{
      render();

      document.querySelectorAll('.chip').forEach(c=>{
        c.addEventListener('click', ()=>{
          document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
          c.classList.add('active');
          currentDomain = c.dataset.domain;
          render();
        });
      });

      document.getElementById('viewMode').addEventListener('change', (e)=>{
        currentView = e.target.value;
        render();
      });

      document.getElementById('btn-today').addEventListener('click', ()=> render());

      document.getElementById('btn-import').addEventListener('click', ()=>{
        const input = document.getElementById('file-input');
        input.value = ""; // reset
        input.click();
      });
      document.getElementById('file-input').addEventListener('change', async (e)=>{
        const f = e.target.files[0];
        if(!f) return;
        try{
          await handleFile(f);
        }catch(err){
          alert('×©×’×™××” ×‘×™×™×‘×•×: ' + (err && err.message ? err.message : err));
        }
      });

      document.getElementById('btn-export').addEventListener('click', exportCSV);
    });
  </script>
</body>
</html>
