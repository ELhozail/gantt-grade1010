<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>לוח גאנט – קובץ יחיד</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css" rel="stylesheet">
  <style>
    body{background:#f6f7fb}
    .card{border-radius:16px}
    /* צבעים */
    .gantt .bar-פדגוגי{ fill:#f06292; }
    .gantt .bar-קהילתי{ fill:#26c6da; }
    .gantt .bar-טכנולוגי{ fill:#ffa000; }
    .gantt .bar-מוסדי{ fill:#66bb6a; }
    .gantt .bar-חברתי{ fill:#9e9e9e; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 m-0">לוח גאנט (קובץ יחיד)</h1>
      <div class="d-flex gap-2">
        <button id="btn-import" class="btn btn-outline-primary btn-sm">ייבוא JSON</button>
        <button id="btn-export" class="btn btn-outline-secondary btn-sm">יצוא CSV</button>
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-body" style="overflow-x:auto;">
        <div id="gantt" style="min-width:1000px;"></div>
      </div>
    </div>
  </div>

  <input type="file" id="file-input" accept="application/json" hidden>

  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <script>
    // ----- נתוני דוגמה -----
    let TASKS = [
      { id:"1", name:"סדנה פתיחת חזון", start:"2025-09-05", end:"2025-09-10", progress:100, domain:"פדגוגי" },
      { id:"2", name:"מיפוי תלמידי שכבה", start:"2025-09-15", end:"2025-10-10", progress:60, domain:"קהילתי" },
      { id:"3", name:"ישומי PBL", start:"2025-10-15", end:"2025-11-20", progress:20, domain:"טכנולוגי" }
    ];

    function toGantt(list){
      return list.map(t => ({
        id: t.id, name: t.name, start: t.start, end: t.end,
        progress: t.progress||0, custom_class: 'bar-' + (t.domain||'')
      }));
    }

    function render(){
      const el = document.getElementById('gantt');
      el.innerHTML = "";
      new Gantt("#gantt", toGantt(TASKS), {
        view_mode: "Month",
        custom_popup_html: task => {
          const t = TASKS.find(x=>x.id===task.id) || task;
          return `<div class="p-2">
            <div><b>${task.name}</b></div>
            <div>תאריכים: ${task.start} → ${task.end}</div>
            <div>התקדמות: ${task.progress}%</div>
          </div>`;
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      try { render(); }
      catch(e){
        const el = document.getElementById('gantt');
        el.innerHTML = '<div class="text-danger p-3">שגיאה בטעינת לוח הגאנט. ודא/י שיש אינטרנט ל-CDN.</div>';
        console.error(e);
      }

      // Import
      document.getElementById('btn-import').onclick = () => document.getElementById('file-input').click();
      document.getElementById('file-input').onchange = async (e) => {
        const f = e.target.files[0]; if(!f) return;
        try{
          const text = await f.text();
          const json = JSON.parse(text);
          if (!Array.isArray(json)) throw new Error('JSON חייב להיות מערך של משימות');
          TASKS = json;
          render();
          alert('ייבוא הושלם');
        } catch(err){
          alert('שגיאה בייבוא: ' + err.message);
        } finally { e.target.value = ""; }
      };

      // Export CSV
      document.getElementById('btn-export').onclick = () => {
        const headers = ["id","name","start","end","progress","domain"];
        const rows = TASKS.map(t=>headers.map(h=>t[h]??""));
        const csv = [headers, ...rows].map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'gantt.csv';
        a.click();
      };
    });
  </script>
</body>
</html>
